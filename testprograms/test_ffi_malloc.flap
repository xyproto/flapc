// test_ffi_malloc.flap - FFI example with safe memory operations

// Allocate memory for mixed data types
size = 64
ptr = call("malloc", size as uint64)
//printf("Allocated %d bytes at pointer: %f\n", size as int32, ptr)
printf("Allocated memory at pointer: %f\n", ptr)

// Write different types safely
write_i32(ptr, 0, 42)           // Write int32 at index 0
write_f64(ptr, 1, 3.14159)      // Write float64 at index 1
write_u8(ptr, 2, 255)           // Write byte at index 2
write_i64(ptr, 3, 9999999)      // Write int64 at index 3
printf("Data written to memory\n")

// Read back the values
val_i32 = read_i32(ptr, 0)
val_f64 = read_f64(ptr, 1)
val_u8 = read_u8(ptr, 2)
val_i64 = read_i64(ptr, 3)

printf("Read i32: %f\n", val_i32)
printf("Read f64: %f\n", val_f64)
printf("Read u8: %f\n", val_u8)
printf("Read i64: %f\n", val_i64)

// Free the memory
call("free", ptr as ptr)
printf("Memory freed\n")

